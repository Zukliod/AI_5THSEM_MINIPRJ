<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demographic Changes Map</title>
    <!-- Use Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #map {
            height: 60vh;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
        }
        .image-container {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .image-card {
            flex: 1;
            background-color: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .image-card img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 p-8 flex flex-col items-center">

    <div class="max-w-4xl w-full bg-white rounded-xl shadow-lg p-8 space-y-6">
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-gray-800">Geographic & Demographic Mapper</h1>
            <p class="mt-2 text-lg text-gray-500">
                Visualize changes over time and explore the significance of places.
            </p>
        </header>

        <!-- Map and Controls -->
        <div class="flex flex-col md:flex-row gap-6">
            <div class="flex-1">
                <div id="map"></div>
                
                <!-- Timeline Controls -->
                <div class="mt-4 p-4 bg-gray-50 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-700">Timeline Comparison</h2>
                    <div class="flex items-center gap-4 mt-2">
                        <label for="timeline-select" class="text-gray-600">Select Timeline:</label>
                        <select id="timeline-select" class="flex-1 p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="historical">Historical View (1990)</option>
                            <option value="current" selected>Current View (2024)</option>
                            <option value="future">Projected View (2030)</option>
                        </select>
                    </div>
                </div>

                <!-- Search Feature -->
                <div class="mt-4 p-4 bg-gray-50 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-700">Search for a Place</h2>
                    <div class="flex items-center gap-4 mt-2">
                        <input type="text" id="search-input" class="flex-1 p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., India Gate">
                        <button id="search-button" class="p-2 px-4 rounded-md bg-blue-500 text-white font-semibold hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Search</button>
                    </div>
                </div>

            </div>

            <!-- Description Panel -->
            <div id="info-panel" class="w-full md:w-1/3 p-6 bg-blue-50 border-l-4 border-blue-200 rounded-lg shadow-md space-y-4">
                <div id="panel-content">
                    <h2 class="text-2xl font-bold text-blue-800">Place Information</h2>
                    <p class="text-blue-700 mt-2">Click on a highlighted area on the map to see details about its history, current status, and future projections.</p>
                </div>
                <div id="image-comparison" class="image-container hidden">
                    <div class="image-card">
                        <h3 class="text-lg font-semibold text-gray-700">Historical</h3>
                        <img id="image-historical" src="https://placehold.co/200x150/e5e7eb/4b5563?text=Historical" alt="Historical View">
                    </div>
                    <div class="image-card">
                        <h3 class="text-lg font-semibold text-gray-700">Current</h3>
                        <img id="image-current" src="https://placehold.co/200x150/e5e7eb/4b5563?text=Current" alt="Current View">
                    </div>
                    <div class="image-card">
                        <h3 class="text-lg font-semibold text-gray-700">AI Generated Future</h3>
                        <img id="image-future" src="https://placehold.co/200x150/e5e7eb/4b5563?text=Future" alt="Future View">
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Leaflet and JS scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // --- Core Application Logic ---

        // 1. Initialize the map
        const map = L.map('map').setView([28.6139, 77.2090], 15); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let highlightedLayer = null;
        let currentLayer = null;
        let placesData = [];
        
        // This function is no longer used since we are now using local image paths.
        // It's a good practice to remove unused code.

        // Function to call the API for text generation
        async function generateText(prompt) {
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{
                        text: prompt
                    }]
                }]
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const fetchWithRetry = async (url, options, retries = 3) => {
                let delay = 1000;
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.status === 429 && i < retries - 1) { // Too many requests
                            console.warn(`API call limit reached. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            continue;
                        }
                        return response;
                    } catch (error) {
                        if (i < retries - 1) {
                            console.warn(`API call failed. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                        } else {
                            throw error;
                        }
                    }
                }
                return null;
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error('Text generation failed:', result);
                    return null; // Return null on error
                }
            } catch (error) {
                console.error('Fetch error:', error);
                return null; // Return null on error
            }
        }


        // 4. Function to update the information panel
        async function updateInfoPanel(properties, lat, lon) {
            const panel = document.getElementById('panel-content');
            panel.innerHTML = `<h2 class="text-2xl font-bold text-blue-800">${properties.name}</h2>
                               <div class="mt-4 text-center">Loading details...</div>`;
            document.getElementById('image-comparison').classList.remove('hidden');

            // Generate descriptive text for custom areas if properties.demographics is not defined
            if (!properties.demographics) {
                const prompt = `Provide a short, 3-sentence description of a hypothetical place at latitude ${lat} and longitude ${lon} in New Delhi, India. The description should be engaging and include details about its demographics, potential changes, and historical significance, as if you were a city planner. The demographics should be an educated guess based on the location.`;
                const description = await generateText(prompt);
                
                // Use a fallback description if the LLM call fails
                properties.demographics = description || "This is a user-selected area for visual analysis and projection. Detailed demographic data is not available.";
                properties.changes = "Changes in this area are based on AI-generated projections and may not reflect real-world data. They are for illustrative purposes to show potential development.";
                properties.significance = "This is a user-selected area for visual analysis and projection.";
            }

            panel.innerHTML = `
                <h2 class="text-2xl font-bold text-blue-800">${properties.name}</h2>
                <h3 class="text-xl font-semibold text-blue-700 mt-4">Demographics:</h3>
                <p class="text-blue-600">${properties.demographics}</p>
                <h3 class="text-xl font-semibold text-blue-700 mt-4">Changes:</h3>
                <p class="text-blue-600">${properties.changes}</p>
                <h3 class="text-xl font-semibold text-blue-700 mt-4">Significance:</h3>
                <p class="text-blue-600">${properties.significance}</p>
            `;

            // Use the properties to update the images from local paths
            document.getElementById('image-historical').src = properties.historicalImageUrl;
            document.getElementById('image-current').src = properties.currentImageUrl;
            document.getElementById('image-future').src = properties.futureImageUrl;

        }

        // 5. Event listener for the timeline dropdown
        document.getElementById('timeline-select').addEventListener('change', function(event) {
            const selectedValue = event.target.value;
            let dataToShow;
            switch(selectedValue) {
                case 'historical':
                    dataToShow = historicalData;
                    break;
                case 'current':
                    dataToShow = currentData;
                    break;
                case 'future':
                    dataToShow = futureData;
                    break;
                default:
                    dataToShow = currentData;
            }
            // Clear any manual highlights before drawing pre-defined data
            if (highlightedLayer) {
                map.removeLayer(highlightedLayer);
            }
            drawMap(dataToShow);
        });

        // 2. Define data for different time periods (Simulated data)
        const historicalData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Red Fort (1990)",
                        "demographics": "Historic, cultural hub.",
                        "changes": "The area was primarily a historic monument with limited commercial activity.",
                        "significance": "A UNESCO World Heritage site and a symbol of India's independence.",
                        "color": "red"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [[77.2384, 28.6565], [77.2435, 28.6565], [77.2435, 28.6525], [77.2384, 28.6525], [77.2384, 28.6565]]
                        ]
                    }
                }
            ]
        };

        const currentData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Connaught Place (2024)",
                        "demographics": "High-density, commercial and retail hub.",
                        "changes": "Rapid commercial development and urbanization led to increased population density, modern infrastructure, and a vibrant nightlife.",
                        "significance": "The heart of modern India's political and economic life. Changes were driven by economic liberalization and the need for a modern capital.",
                        "color": "blue"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [[77.214, 28.636], [77.222, 28.636], [77.222, 28.629], [77.214, 28.629], [77.214, 28.636]]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Upcoming Development Zone (2030)",
                        "demographics": "Projected high-tech, mixed-use.",
                        "changes": "Planned smart city initiatives will transform this area into a hub for technology and sustainable living.",
                        "significance": "This area represents the future vision for sustainable and technologically advanced urban planning, addressing challenges like traffic and pollution.",
                        "color": "green"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [[77.15, 28.55], [77.18, 28.55], [77.18, 28.53], [77.15, 28.53], [77.15, 28.55]]
                        ]
                    }
                }
            ]
        };

        const futureData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Red Fort (2030)",
                        "demographics": "Historic, cultural hub with improved tourist amenities.",
                        "changes": "Expected improvements in public transport and tourist facilities to handle increased visitors.",
                        "significance": "Remains a key cultural landmark, with enhancements to preserve its heritage and improve accessibility.",
                        "color": "red"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [[77.2384, 28.6565], [77.2435, 28.6565], [77.2435, 28.6525], [77.2384, 28.6525], [77.2384, 28.6565]]
                        ]
                    }
                }
            ]
        };

        // Minimal drawMap implementation: render GeoJSON features and wire clicks
        function drawMap(geojson) {
            // Remove previous layer if present
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            currentLayer = L.geoJSON(geojson, {
                style: function(feature) {
                    return {
                        color: feature.properties && feature.properties.color ? feature.properties.color : '#3388ff',
                        weight: 2,
                        fillOpacity: 0.1
                    };
                },
                onEachFeature: function(feature, layer) {
                    // When a predefined feature is clicked, update the info panel and highlight it
                    layer.on('click', function(e) {
                        // Remove any existing highlight rectangle
                        if (highlightedLayer && highlightedLayer !== layer) {
                            try { highlightedLayer.setStyle && highlightedLayer.setStyle({weight:2}); } catch (err) {}
                        }

                        // If the feature is a path, visually emphasize it
                        try {
                            layer.setStyle && layer.setStyle({weight: 4});
                            highlightedLayer = layer;
                        } catch (err) {
                            // ignore if not applicable
                        }

                        const props = feature.properties || { name: 'Feature' };
                        const center = layer.getBounds ? layer.getBounds().getCenter() : e.latlng;
                        updateInfoPanel(props, center.lat, center.lng);
                    });
                }
            }).addTo(map);
        }

        // Function to handle map clicks and search results
        function onMapClick(e) {
            // Remove any existing highlights
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            if (highlightedLayer) {
                map.removeLayer(highlightedLayer);
            }

            const latlng = e.latlng;
            const lat = latlng.lat;
            const lon = latlng.lng;
            
            // Define the size of the square in km
            const sizeInKm = 0.5; 

            // Calculate the approximate delta in lat and lon
            const latDelta = sizeInKm / 111.32; 
            const lonDelta = sizeInKm / (111.32 * Math.cos(lat * Math.PI / 180)); 

            // Create a polygon based on the location
            const bounds = [
                [lat - latDelta / 2, lon - lonDelta / 2],
                [lat + latDelta / 2, lon + lonDelta / 2]
            ];
            
            highlightedLayer = L.rectangle(bounds, {
                color: "#ff7800",
                weight: 2,
                fillOpacity: 0.2
            }).addTo(map);

            map.setView([lat, lon], 15);
            
            // Check if the location is in our pre-defined dataset
            let foundPlace = null;
            if (placesData) {
                for (const place of placesData) {
                    const distance = map.distance(latlng, [place.lat, place.lon]);
                    if (distance < 500) { // 500 meters
                        foundPlace = place;
                        break;
                    }
                }
            }

            if (foundPlace) {
                updateInfoPanel(foundPlace, foundPlace.lat, foundPlace.lon);
            } else {
                // If not in the dataset, use LLM generation
                updateInfoPanel({
                    name: `Selected Area at ${lat.toFixed(4)}, ${lon.toFixed(4)}`,
                    demographics: null,
                    changes: null,
                    significance: null
                }, lat, lon);
            }
        }

        // Function to handle the search button click
        async function searchPlace() {
            const query = document.getElementById('search-input').value;
            if (!query) return;
            
            const apiUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const place = data[0];
                    const lat = parseFloat(place.lat);
                    const lon = parseFloat(place.lon);
                    
                    // Just set the map view, do not highlight or update info panel
                    map.setView([lat, lon], 15);
                } else {
                    console.log('Location not found. Please try a different query.');
                }
            } catch (error) {
                console.error("Search failed:", error);
                console.log('Search failed. Please try again later.');
            }
        }
        
        // Fetch and process the JSON data on page load
        async function fetchPlacesData() {
            try {
                const response = await fetch('placesData.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                placesData = data;
            } catch (error) {
                console.error('Could not fetch placesData.json:', error);
                placesData = [];
            }
        }

        // Initial map load with current data and setup click listeners
        window.onload = async function() {
            await fetchPlacesData();
            drawMap(currentData);
            map.on('click', onMapClick);
            document.getElementById('search-button').addEventListener('click', searchPlace);
        };
    </script>
</body>
</html>
